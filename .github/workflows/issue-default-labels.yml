name: Issue default labels

on:
  issues:
    types: [opened, reopened, edited]

permissions:
  issues: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Apply status:needs-review and priority label
        uses: actions/github-script@v7
        with:
          script: |
            const STATUS_LABEL = "status:needs-review";
            const PRIORITY_LABELS = [
              "priority:critical",
              "priority:high",
              "priority:medium",
              "priority:low",
              "priority:backlog",
            ];

            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            const currentLabels = (issue.labels || []).map(l => l.name);

            // Ensure status label
            if (!currentLabels.includes(STATUS_LABEL)) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number,
                labels: [STATUS_LABEL],
              });
            }

            // Extract selected priority from Issue Form body
            const body = issue.body || "";
            const m = body.match(/### Priority\s+([\s\S]*?)(?:\n### |\n$)/);
            const picked = m ? m[1].trim().split("\n").find(l => l.trim().length > 0)?.trim() : null;

            if (!picked || !PRIORITY_LABELS.includes(picked)) {
              return; // No valid priority found
            }

            // Remove any other priority labels
            for (const l of currentLabels) {
              if (PRIORITY_LABELS.includes(l) && l !== picked) {
                try {
                  await github.rest.issues.removeLabel({
                    owner, repo, issue_number,
                    name: l,
                  });
                } catch (e) {
                  // ignore
                }
              }
            }

            // Add picked priority label if missing
            if (!currentLabels.includes(picked)) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number,
                labels: [picked],
              });
            }
