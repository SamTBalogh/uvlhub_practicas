name: Issue default labels

on:
  issues:
    types: [opened, reopened, edited]

permissions:
  issues: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Apply status, type and priority labels from Issue Form
        uses: actions/github-script@v7
        with:
          script: |
            const STATUS_LABEL = "status:needs-review";

            const PRIORITY_LABELS = [
              "priority:critical",
              "priority:high",
              "priority:medium",
              "priority:low",
              "priority:backlog",
            ];

            const TYPE_LABELS = [
              "type:documentation",
              "type:bug",
              "type:feature",
              "type:refactor",
              "type:chore",
            ];

            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            const body = issue.body || "";
            const currentLabels = new Set((issue.labels || []).map(l => l.name));

            const addLabel = async (label) => {
              if (currentLabels.has(label)) return;
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: [label] });
              currentLabels.add(label);
            };

            const removeLabel = async (label) => {
              if (!currentLabels.has(label)) return;
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name: label });
              } catch (e) {}
              currentLabels.delete(label);
            };

            const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

            const extractSectionValue = (heading) => {
              const re = new RegExp(
                `^###\\s+${escapeRegExp(heading)}\\s*$\\n([\\s\\S]*?)(?=\\n###\\s|$)`,
                "mi"
              );
              const m = body.match(re);
              if (!m || !m[1]) return null;
              return m[1]
                .split("\n")
                .map(x => x.trim())
                .filter(Boolean)[0] || null;
            };

            // Read values from the Issue Form
            const pickedTypeValue = extractSectionValue("Type");        // e.g. "type:feature"
            const pickedPriority = extractSectionValue("Priority");     // e.g. "priority:high"

            // Priority fallback: backlog means "not triaged yet"
            const effectivePriority = (pickedPriority && PRIORITY_LABELS.includes(pickedPriority))
              ? pickedPriority
              : "priority:backlog";

            // 1) Apply priority label (single-choice)
            for (const l of PRIORITY_LABELS) if (l !== effectivePriority) await removeLabel(l);
            await addLabel(effectivePriority);

            // 2) status:needs-review stays while backlog, removed otherwise
            if (effectivePriority === "priority:backlog") {
              await addLabel(STATUS_LABEL);
            } else {
              await removeLabel(STATUS_LABEL);
            }

            // 3) Apply type label (single-choice)
            if (pickedTypeValue && TYPE_LABELS.includes(pickedTypeValue)) {
              for (const l of TYPE_LABELS) if (l !== pickedTypeValue) await removeLabel(l);
              await addLabel(pickedTypeValue);
            }
