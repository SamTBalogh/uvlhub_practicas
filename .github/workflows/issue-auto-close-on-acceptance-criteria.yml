name: Auto-close when Acceptance Criteria is complete

on:
  issues:
    types: [edited, reopened]

permissions:
  issues: write

jobs:
  autoclose:
    runs-on: ubuntu-latest
    if: github.event.issue.state == 'open'
    steps:
      - name: Close issue when all Acceptance criteria checkboxes are checked
        uses: actions/github-script@v7
        with:
          script: |
            // IMPORTANT: do not autoclose on "reopened"
            if (context.payload.action === "reopened") return;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // Always fetch the latest body from the API
            const { data: issueData } = await github.rest.issues.get({
              owner,
              repo,
              issue_number,
            });

            const body = issueData.body || "";
            const HEADING = "Acceptance criteria";

            const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

            const extractSectionText = (heading) => {
              const re = new RegExp(
                `^###\\s+${escapeRegExp(heading)}\\s*$\\n([\\s\\S]*?)(?=\\n###\\s|$)`,
                "mi"
              );
              const m = body.match(re);
              return (m && m[1]) ? m[1].trim() : null;
            };

            const section = extractSectionText(HEADING);
            if (!section) return;

            const lines = section.split("\n");

            // More permissive task detection (accepts "- [ ]foo" and "- [ ] foo")
            const taskLineRe = /^\s*[-*+]\s*\[( |x|X)\]\s*/;
            const uncheckedRe = /^\s*[-*+]\s*\[\s*\]\s*/;

            const taskLines = lines.filter(l => taskLineRe.test(l));
            if (taskLines.length === 0) return;

            const hasUnchecked = taskLines.some(l => uncheckedRe.test(l));
            if (hasUnchecked) return;

            await github.rest.issues.update({
              owner,
              repo,
              issue_number,
              state: "closed",
            });