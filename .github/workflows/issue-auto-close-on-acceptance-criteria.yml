name: Auto-close when Acceptance Criteria is complete

on:
  issues:
    types: [edited, reopened]

permissions:
  issues: write

jobs:
  autoclose:
    runs-on: ubuntu-latest
    if: github.event.issue.state == 'open'
    steps:
      - name: Close issue when all Acceptance criteria checkboxes are checked
        uses: actions/github-script@v7
        with:
          script: |
            if (context.payload.action === "reopened") return;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const { data: issueData } = await github.rest.issues.get({ owner, repo, issue_number });
            const body = issueData.body || "";

            const HEADING = "Acceptance criteria";
            const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

            const extractSectionText = (heading) => {
              // permite "### Acceptance criteria" y tambiÃ©n "### Acceptance criteria:" por si acaso
              const re = new RegExp(
                `^###\\s+${escapeRegExp(heading)}\\s*:?\s*$\\r?\\n([\\s\\S]*?)(?=\\r?\\n###\\s|$)`,
                "mi"
              );
              const m = body.match(re);
              return m?.[1]?.trim() ?? null;
            };

            const section = extractSectionText(HEADING);
            if (!section) return;

            // Formato garantizado: "- [x] " y "- [ ] "
            const taskRe = /^\s*-\s*\[(?: |x|X)\]\s+/gm;
            const uncheckedRe = /^\s*-\s*\[ \]\s+/gm;

            const tasks = section.match(taskRe) ?? [];
            const unchecked = section.match(uncheckedRe) ?? [];

            console.log(`Acceptance criteria tasks detected: ${tasks.length}`);
            console.log(`Unchecked tasks detected: ${unchecked.length}`);

            if (tasks.length === 0) return;     // no hay nada que autocerrar
            if (unchecked.length > 0) return;   // queda alguna sin marcar

            await github.rest.issues.update({
              owner,
              repo,
              issue_number,
              state: "closed",
            });
