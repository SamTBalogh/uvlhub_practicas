name: Auto-close when Acceptance Criteria is complete

on:
  issues:
    types: [edited, reopened]

permissions:
  issues: write

jobs:
  autoclose:
    runs-on: ubuntu-latest
    if: github.event.issue.state == 'open'
    steps:
      - name: Close issue when all Acceptance criteria checkboxes are checked
        uses: actions/github-script@v7
        with:
          script: |
            if (context.payload.action === "reopened") return;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            console.log(`ref=${context.ref} sha=${context.sha} action=${context.payload.action}`);

            const { data: issueData } = await github.rest.issues.get({ owner, repo, issue_number });
            const body = issueData.body || "";
            const lines = body.split(/\r?\n/);

            const acHeadingRe = /^\s*###\s+Acceptance criteria\s*$/i;

            const start = lines.findIndex(l => acHeadingRe.test(l));
            if (start === -1) {
              console.log("No Acceptance criteria heading found");
              return;
            }

            let inCode = false;
            let total = 0;
            let unchecked = 0;

            // Formato garantizado: "- [x]" o "- [ ]"
            const taskRe = /^\s*-\s*\[([^\]])\]/;

            // Escaneamos desde el heading hasta el final (sin recortar por otros ###)
            for (let i = start + 1; i < lines.length; i++) {
              const line = lines[i];

              if (/^\s*```/.test(line)) { inCode = !inCode; continue; }
              if (inCode) continue;

              const m = line.match(taskRe);
              if (!m) continue;

              total += 1;

              const mark = (m[1] || "").trim().toLowerCase(); // si no es "x", NO estÃ¡ marcada
              if (mark !== "x") unchecked += 1;
            }

            console.log(`AC tasks detected=${total} unchecked=${unchecked}`);

            if (total === 0) return;
            if (unchecked > 0) return;

            await github.rest.issues.update({ owner, repo, issue_number, state: "closed" });
